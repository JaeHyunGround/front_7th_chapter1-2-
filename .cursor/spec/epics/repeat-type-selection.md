# 반복 유형 선택

## 요약 (Summary)

일정 생성 또는 수정 시 반복 유형(매일, 매주, 매월, 매년)을 선택할 수 있습니다.
특정 날짜(31일, 윤년 2월 29일)의 특수 케이스를 정확히 처리하며, 반복 일정은 일정 겹침 검증을 수행하지 않습니다.

## 배경 (Background)

### 왜 이 기능을 만드는가?

사용자는 주기적으로 반복되는 일정(주간 회의, 월간 보고, 연간 기념일 등)을 효율적으로 관리해야 합니다. 동일한 일정을 반복 입력하는 것은 비효율적이며 실수를 유발할 수 있습니다.

### 어떤 사용자 문제를 해결하는가?

- 반복적인 일정 입력의 번거로움 해소
- 주기적인 일정의 일관성 유지
- 장기 반복 일정의 효율적인 관리

## 목표 (Goals)

- 일정 생성/수정 시 반복 여부를 선택할 수 있다.
- 4가지 반복 유형(매일, 매주, 매월, 매년)을 지원한다.
- 반복 간격을 1 이상의 정수로 설정할 수 있다.
- 반복 종료일을 선택적으로 설정할 수 있다.
- 매월 반복 시 해당 날짜가 없는 달은 건너뛴다. (예: 31일은 2월, 4월 등 건너뜀)
- 매년 반복 시 해당 날짜가 없는 해는 건너뛴다. (예: 2월 29일은 평년 건너뜀)
- 반복 일정 생성 시 일정 겹침 검증을 수행하지 않는다.

## 목표가 아닌 것 (Non-Goals)

- 요일 기반 반복 규칙 (예: 매월 첫째 주 월요일)
- 여러 요일 선택 반복 (예: 월, 수, 금)
- 반복 일정의 개별 인스턴스 수정/삭제
- 반복 일정 간의 겹침 검증

## 계획 (Plan)

### 예상 동작 (Expected Behaviors)

#### 1. 반복 일정 활성화/비활성화

**동작 명세**:

- 반복 일정 체크박스를 체크하면 `isRepeating`이 `true`가 된다.
- 반복 일정 체크박스를 해제하면 `isRepeating`이 `false`가 된다.
- `isRepeating`이 `true`일 때 반복 설정 UI가 표시된다.
- `isRepeating`이 `false`일 때 반복 설정 UI가 숨겨진다.

**검증 포인트**:

```
Given: 일정 생성 폼
When: 반복 일정 체크박스를 체크
Then: 반복 유형, 반복 간격, 반복 종료일 필드가 표시됨

Given: 반복 일정이 체크된 상태
When: 체크박스를 해제
Then: 반복 설정 UI가 숨겨지고 repeat.type이 'none'이 됨
```

#### 2. 반복 유형 선택

**동작 명세**:

- 반복 유형 드롭다운은 4가지 옵션을 제공한다: 매일, 매주, 매월, 매년
- 기본값은 '매일'이다.
- 선택한 유형은 `repeatType` 상태에 저장된다.

**데이터 타입**:

```typescript
type RepeatType = 'none' | 'daily' | 'weekly' | 'monthly' | 'yearly';
```

**검증 포인트**:

```
Given: 반복 일정이 활성화된 상태
When: 반복 유형을 '매주'로 선택
Then: repeatType이 'weekly'가 됨

Given: 반복 일정을 새로 활성화
When: 아무것도 선택하지 않음
Then: repeatType의 기본값은 'daily'
```

#### 3. 반복 간격 입력

**동작 명세**:

- 반복 간격은 1 이상의 정수만 허용한다.
- 기본값은 1이다.
- 0 이하의 값은 허용하지 않는다.
- 소수점은 허용하지 않는다.

**검증 포인트**:

```
Given: 반복 간격 입력 필드
When: 1을 입력
Then: 유효한 값으로 인정됨

Given: 반복 간격 입력 필드
When: 0을 입력
Then: "반복 간격은 1 이상이어야 합니다." 오류 표시

Given: 반복 간격 입력 필드
When: -1을 입력
Then: "반복 간격은 1 이상이어야 합니다." 오류 표시

Given: 반복 간격 입력 필드
When: 1.5를 입력
Then: "반복 간격은 정수여야 합니다." 오류 표시

Given: 오류가 있는 상태
When: 일정 추가 버튼 클릭
Then: 일정이 저장되지 않음
```

#### 4. 반복 종료일 입력

**동작 명세**:

- 반복 종료일은 선택적(optional)이다.
- 종료일이 없으면 무기한 반복된다.
- YYYY-MM-DD 형식만 허용한다.
- 유효한 날짜여야 한다.
- 시작 날짜와 같거나 이후여야 한다.

**검증 포인트**:

```
Given: 반복 종료일 입력 필드
When: 아무것도 입력하지 않음
Then: 유효한 상태 (무기한 반복)

Given: 시작일이 2024-01-15
When: 종료일을 2024-12-31로 입력
Then: 유효한 값으로 인정됨

Given: 반복 종료일 입력 필드
When: '2024-02-30'을 입력
Then: "유효하지 않은 날짜입니다." 오류 표시

Given: 반복 종료일 입력 필드
When: '24-01-01' 형식으로 입력
Then: "날짜 형식이 올바르지 않습니다. (YYYY-MM-DD)" 오류 표시

Given: 시작일이 2024-01-15
When: 종료일을 2024-01-14로 입력
Then: "종료일은 시작일보다 미래여야 합니다." 오류 표시
```

#### 5. 매일 반복 생성

**동작 명세**:

- 시작일부터 종료일까지 매 N일마다 일정을 생성한다.
- N은 반복 간격이다.
- 종료일이 없으면 표시 중인 범위까지만 생성한다.

**검증 포인트**:

```
Given: 시작일 2024-01-01, 반복 유형 매일, 간격 1
When: 일정을 생성
Then: 2024-01-01, 2024-01-02, 2024-01-03, ... 매일 일정 생성

Given: 시작일 2024-01-01, 반복 유형 매일, 간격 2
When: 일정을 생성
Then: 2024-01-01, 2024-01-03, 2024-01-05, ... 이틀마다 일정 생성

Given: 시작일 2024-01-01, 반복 유형 매일, 간격 1, 종료일 2024-01-05
When: 일정을 생성
Then: 2024-01-01, 2024-01-02, 2024-01-03, 2024-01-04, 2024-01-05만 생성
```

#### 6. 매주 반복 생성

**동작 명세**:

- 시작일부터 종료일까지 매 N주마다 동일 요일에 일정을 생성한다.
- N은 반복 간격이다.

**검증 포인트**:

```
Given: 시작일 2024-01-01 (월요일), 반복 유형 매주, 간격 1
When: 일정을 생성
Then: 2024-01-01, 2024-01-08, 2024-01-15, ... 매주 월요일마다 생성

Given: 시작일 2024-01-01 (월요일), 반복 유형 매주, 간격 2
When: 일정을 생성
Then: 2024-01-01, 2024-01-15, 2024-01-29, ... 격주 월요일마다 생성

Given: 시작일 2024-01-07 (일요일), 반복 유형 매주, 간격 1
When: 일정을 생성
Then: 2024-01-07, 2024-01-14, 2024-01-21, ... 매주 일요일마다 생성
```

#### 7. 매월 반복 생성 - 일반 케이스

**동작 명세**:

- 시작일부터 종료일까지 매 N개월마다 동일 날짜에 일정을 생성한다.
- N은 반복 간격이다.
- 해당 날짜가 존재하지 않는 달은 건너뛴다.

**검증 포인트**:

```
Given: 시작일 2024-01-15, 반복 유형 매월, 간격 1
When: 일정을 생성
Then: 2024-01-15, 2024-02-15, 2024-03-15, ... 매월 15일에 생성

Given: 시작일 2024-01-15, 반복 유형 매월, 간격 2
When: 일정을 생성
Then: 2024-01-15, 2024-03-15, 2024-05-15, ... 격월 15일에 생성

Given: 시작일 2024-01-15, 반복 유형 매월, 간격 3
When: 일정을 생성
Then: 2024-01-15, 2024-04-15, 2024-07-15, ... 분기마다 15일에 생성
```

#### 8. 매월 반복 생성 - 31일 특수 케이스

**동작 명세**:

- 31일에 매월 반복을 선택하면 31일이 있는 달에만 일정을 생성한다.
- 31일이 없는 달(2월, 4월, 6월, 9월, 11월)은 건너뛴다.
- 마지막 날로 변환하지 않는다.

**검증 포인트**:

```
Given: 시작일 2024-01-31, 반복 유형 매월, 간격 1
When: 1년 치 일정을 생성
Then: 다음 날짜에만 일정이 생성됨
  - 2024-01-31 ✓ (31일 있음)
  - 2024-02-xx ✗ (31일 없음, 건너뜀)
  - 2024-03-31 ✓ (31일 있음)
  - 2024-04-xx ✗ (31일 없음, 건너뜀)
  - 2024-05-31 ✓ (31일 있음)
  - 2024-06-xx ✗ (31일 없음, 건너뜀)
  - 2024-07-31 ✓ (31일 있음)
  - 2024-08-31 ✓ (31일 있음)
  - 2024-09-xx ✗ (31일 없음, 건너뜀)
  - 2024-10-31 ✓ (31일 있음)
  - 2024-11-xx ✗ (31일 없음, 건너뜀)
  - 2024-12-31 ✓ (31일 있음)
```

#### 9. 매월 반복 생성 - 30일 특수 케이스

**동작 명세**:

- 30일에 매월 반복을 선택하면 30일이 있는 달에만 일정을 생성한다.
- 30일이 없는 달(2월)은 건너뛴다.

**검증 포인트**:

```
Given: 시작일 2024-01-30, 반복 유형 매월, 간격 1
When: 6개월 치 일정을 생성
Then: 다음 날짜에만 일정이 생성됨
  - 2024-01-30 ✓ (30일 있음)
  - 2024-02-xx ✗ (30일 없음, 건너뜀)
  - 2024-03-30 ✓ (30일 있음)
  - 2024-04-30 ✓ (30일 있음)
  - 2024-05-30 ✓ (30일 있음)
  - 2024-06-30 ✓ (30일 있음)
```

#### 10. 매월 반복 생성 - 29일 특수 케이스

**동작 명세**:

- 29일에 매월 반복을 선택하면 29일이 있는 달에만 일정을 생성한다.
- 평년 2월은 건너뛴다.
- 윤년 2월은 포함한다.

**검증 포인트**:

```
Given: 시작일 2024-01-29 (윤년), 반복 유형 매월, 간격 1
When: 3개월 치 일정을 생성
Then: 다음 날짜에만 일정이 생성됨
  - 2024-01-29 ✓ (29일 있음)
  - 2024-02-29 ✓ (윤년이라 29일 있음)
  - 2024-03-29 ✓ (29일 있음)

Given: 시작일 2023-01-29 (평년), 반복 유형 매월, 간격 1
When: 3개월 치 일정을 생성
Then: 다음 날짜에만 일정이 생성됨
  - 2023-01-29 ✓ (29일 있음)
  - 2023-02-xx ✗ (평년이라 29일 없음, 건너뜀)
  - 2023-03-29 ✓ (29일 있음)
```

#### 11. 매년 반복 생성 - 일반 케이스

**동작 명세**:

- 시작일부터 종료일까지 매 N년마다 동일 월/일에 일정을 생성한다.
- N은 반복 간격이다.

**검증 포인트**:

```
Given: 시작일 2024-01-15, 반복 유형 매년, 간격 1
When: 일정을 생성
Then: 2024-01-15, 2025-01-15, 2026-01-15, ... 매년 1월 15일에 생성

Given: 시작일 2024-01-15, 반복 유형 매년, 간격 2
When: 일정을 생성
Then: 2024-01-15, 2026-01-15, 2028-01-15, ... 2년마다 1월 15일에 생성

Given: 시작일 2024-12-25, 반복 유형 매년, 간격 1
When: 일정을 생성
Then: 2024-12-25, 2025-12-25, 2026-12-25, ... 매년 12월 25일에 생성
```

#### 12. 매년 반복 생성 - 윤년 2월 29일 특수 케이스

**동작 명세**:

- 윤년 2월 29일에 매년 반복을 선택하면 2월 29일이 있는 해(윤년)에만 일정을 생성한다.
- 평년은 건너뛴다.
- 2월 28일이나 3월 1일로 변환하지 않는다.

**윤년 판별 규칙**:

- 4로 나누어떨어지는 해는 윤년
- 단, 100으로 나누어떨어지는 해는 평년
- 단, 400으로 나누어떨어지는 해는 윤년

**검증 포인트**:

```
Given: 시작일 2024-02-29 (윤년), 반복 유형 매년, 간격 1
When: 10년 치 일정을 생성
Then: 다음 날짜에만 일정이 생성됨
  - 2024-02-29 ✓ (윤년)
  - 2025-02-xx ✗ (평년, 건너뜀)
  - 2026-02-xx ✗ (평년, 건너뜀)
  - 2027-02-xx ✗ (평년, 건너뜀)
  - 2028-02-29 ✓ (윤년)
  - 2029-02-xx ✗ (평년, 건너뜀)
  - 2030-02-xx ✗ (평년, 건너뜀)
  - 2031-02-xx ✗ (평년, 건너뜀)
  - 2032-02-29 ✓ (윤년)
  - 2033-02-xx ✗ (평년, 건너뜀)

Given: 시작일 2000-02-29 (윤년, 400으로 나누어떨어짐), 반복 유형 매년, 간격 100
When: 300년 치 일정을 생성
Then: 다음 날짜에만 일정이 생성됨
  - 2000-02-29 ✓ (400으로 나누어떨어지는 윤년)
  - 2100-02-xx ✗ (100으로 나누어떨어지지만 400으로는 안 떨어져서 평년)
  - 2200-02-xx ✗ (평년)
  - 2300-02-xx ✗ (평년)
```

#### 13. 일정 저장 데이터 구조

**동작 명세**:

- 반복 일정이 활성화되면 `repeat` 객체에 반복 정보를 저장한다.
- 반복 일정이 비활성화되면 `repeat.type`을 'none'으로 저장한다.

**데이터 타입**:

```typescript
interface RepeatInfo {
  type: RepeatType;
  interval: number;
  endDate?: string;
}

interface Event {
  id: string;
  title: string;
  date: string;
  startTime: string;
  endTime: string;
  description: string;
  location: string;
  category: string;
  repeat: RepeatInfo;
  notificationTime: number;
}
```

**검증 포인트**:

```
Given: 반복 일정 활성화, 매주, 간격 2, 종료일 2024-12-31
When: 일정을 저장
Then: Event.repeat = {
  type: 'weekly',
  interval: 2,
  endDate: '2024-12-31'
}

Given: 반복 일정 비활성화
When: 일정을 저장
Then: Event.repeat = {
  type: 'none',
  interval: 1,
  endDate: undefined
}
```

#### 14. 반복 일정 수정

**동작 명세**:

- 기존 반복 일정을 수정하면 전체 시리즈가 동일하게 수정된다.
- 개별 인스턴스만 수정하는 기능은 지원하지 않는다.

**검증 포인트**:

```
Given: 기존 반복 일정 (매주)
When: 일정을 편집하여 반복 유형을 매월로 변경
Then: repeat.type이 'monthly'로 변경되고 전체 시리즈가 재생성됨

Given: 기존 반복 일정
When: 일정을 편집하여 반복 체크박스 해제
Then: repeat.type이 'none'이 되고 단일 일정이 됨

Given: 기존 반복 일정
When: 일정 제목을 수정
Then: 모든 반복 인스턴스의 제목이 동일하게 변경됨
```

#### 15. 반복 일정과 겹침 검증

**동작 명세**:

- 반복 일정 생성/수정 시 일정 겹침 검증을 수행하지 않는다.
- 겹침 경고 다이얼로그를 표시하지 않는다.
- 기존 일정과 겹쳐도 바로 저장된다.

**검증 포인트**:

```
Given: 2024-01-15 10:00-11:00에 기존 일정이 있음
When: 2024-01-15 10:00-11:00에 매일 반복 일정을 생성
Then: 겹침 경고 없이 바로 저장됨

Given: 반복 일정을 생성 중
When: repeat.type이 'none'이 아님
Then: findOverlappingEvents 검증을 건너뜀

Given: 일반 일정을 생성 중
When: repeat.type이 'none'임
Then: findOverlappingEvents 검증을 수행함
```

#### 16. 달력 뷰에서 반복 일정 표시

**동작 명세**:

- 반복 일정은 생성 규칙에 따라 해당하는 모든 날짜에 표시된다.
- 각 날짜의 일정은 독립적으로 렌더링된다.

**검증 포인트**:

```
Given: 2024-01-01부터 매일 반복 일정
When: 주간 뷰를 확인
Then: 해당 주의 모든 날짜에 일정이 표시됨

Given: 매주 월요일 반복 일정
When: 월간 뷰를 확인
Then: 해당 월의 모든 월요일에 일정이 표시됨

Given: 31일 매월 반복 일정
When: 2024년 2월 월간 뷰를 확인
Then: 2월에는 일정이 표시되지 않음 (31일 없음)
```

#### 17. 일정 목록에서 반복 정보 표시

**동작 명세**:

- 반복 일정은 반복 정보를 텍스트로 표시한다.
- 표시 형식: "반복: {간격}{단위}마다"
- 종료일이 있으면 함께 표시한다.

**검증 포인트**:

```
Given: repeat.type = 'daily', interval = 1
Then: "반복: 1일마다" 표시

Given: repeat.type = 'weekly', interval = 2
Then: "반복: 2주마다" 표시

Given: repeat.type = 'monthly', interval = 1, endDate = '2024-12-31'
Then: "반복: 1월마다 (종료: 2024-12-31)" 표시

Given: repeat.type = 'yearly', interval = 3
Then: "반복: 3년마다" 표시

Given: repeat.type = 'none'
Then: 반복 정보 표시하지 않음
```

### 기술 요구사항

#### 1. 데이터 타입

```typescript
type RepeatType = 'none' | 'daily' | 'weekly' | 'monthly' | 'yearly';

interface RepeatInfo {
  type: RepeatType;
  interval: number;
  endDate?: string; // YYYY-MM-DD 형식
}

interface EventForm {
  title: string;
  date: string;
  startTime: string;
  endTime: string;
  description: string;
  location: string;
  category: string;
  repeat: RepeatInfo;
  notificationTime: number;
}

interface Event extends EventForm {
  id: string;
}
```

#### 2. 유효성 검증 규칙

**반복 간격**:

- 타입: 정수
- 범위: 1 이상
- 오류 메시지:
  - "반복 간격은 1 이상이어야 합니다." (0 이하)
  - "반복 간격은 정수여야 합니다." (소수점)

**반복 종료일**:

- 타입: 문자열 (optional)
- 형식: YYYY-MM-DD
- 유효성: 존재하는 날짜
- 제약: 시작일 이상
- 오류 메시지:
  - "날짜 형식이 올바르지 않습니다. (YYYY-MM-DD)" (형식 오류)
  - "유효하지 않은 날짜입니다." (존재하지 않는 날짜)
  - "종료일은 시작일보다 미래여야 합니다." (시작일보다 이전)

#### 3. 날짜 계산 로직

**윤년 판별**:

```typescript
function isLeapYear(year: number): boolean {
  if (year % 400 === 0) return true;
  if (year % 100 === 0) return false;
  if (year % 4 === 0) return true;
  return false;
}
```

**특정 월의 마지막 날**:

```typescript
function getDaysInMonth(year: number, month: number): number {
  return new Date(year, month, 0).getDate();
}
```

**날짜 존재 여부 확인**:

```typescript
function isValidDate(year: number, month: number, day: number): boolean {
  const daysInMonth = getDaysInMonth(year, month);
  return day >= 1 && day <= daysInMonth;
}
```

#### 4. 반복 일정 생성 알고리즘

**매일 반복**:

```
시작일에서 시작
종료일까지 또는 표시 범위까지:
  현재 날짜에 일정 생성
  현재 날짜 += interval일
```

**매주 반복**:

```
시작일에서 시작
종료일까지 또는 표시 범위까지:
  현재 날짜에 일정 생성
  현재 날짜 += interval주 (7 * interval일)
```

**매월 반복**:

```
시작일에서 시작
종료일까지 또는 표시 범위까지:
  if 현재 년/월에 시작일의 day가 존재:
    현재 날짜에 일정 생성
  현재 월 += interval개월
```

**매년 반복**:

```
시작일에서 시작
종료일까지 또는 표시 범위까지:
  if 현재 년에 시작일의 month/day가 존재:
    현재 날짜에 일정 생성
  현재 년 += interval년
```

### 제약사항 및 에지 케이스

#### 1. 존재하지 않는 날짜 처리

| 시작일   | 반복 유형 | 건너뛰는 경우            |
| -------- | --------- | ------------------------ |
| 31일     | 매월      | 2월, 4월, 6월, 9월, 11월 |
| 30일     | 매월      | 2월                      |
| 29일     | 매월      | 평년 2월                 |
| 2월 29일 | 매년      | 평년                     |

#### 2. 장기 반복 일정

- 종료일이 없는 경우 무기한 반복
- 달력 뷰 렌더링 시 현재 표시 범위만 계산
- 메모리 효율성을 위해 모든 인스턴스를 미리 생성하지 않음

#### 3. 성능 고려사항

- 반복 일정 생성은 필요 시점에 계산 (lazy evaluation)
- 대량의 반복 일정도 효율적으로 처리
- 달력 뷰에서는 해당 월/주의 일정만 계산

### 구현 우선순위

1. **높음**: 반복 유형 선택, 반복 간격 입력, 매일/매주 반복
2. **중간**: 매월 반복 일반 케이스, 매년 반복 일반 케이스
3. **낮음**: 31일 특수 케이스, 2월 29일 특수 케이스, 반복 종료일

---

**문서 버전**: 2.0  
**작성일**: 2025-10-29  
**작성자**: Doeun (Analyst Agent)  
**목적**: TDD 기반 구현을 위한 명세 문서
