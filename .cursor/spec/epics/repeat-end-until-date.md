# 반복 종료 - 특정 날짜까지 (Until Date)

## 요약 (Summary)

일정의 반복 종료 조건으로 "특정 날짜까지"를 설정할 수 있다. 종료일은 YYYY-MM-DD 형식의 유효한 날짜여야 하며 시작일보다 과거일 수 없다(시작일과 동일 허용). 예시 및 테스트 시나리오에서는 상한 날짜를 2025-12-31로 고정하여 검증한다.

## 배경 (Background)

- 사용자는 반복 일정을 무기한이 아니라 특정 날짜까지만 생성하고 싶다.
- 종료일을 명시함으로써 이후 기간의 불필요한 인스턴스 생성/표시를 방지한다.
- 기존 반복 유형(매일/매주/매월/매년) 및 간격 로직과 결합되어 동작해야 한다.

## 목표 (Goals)

- 반복 종료 옵션으로 "특정 날짜까지"(endDate)를 설정할 수 있다.
- 종료일이 설정되면 생성/표시되는 반복 인스턴스는 종료일을 초과하지 않는다.
- 종료일 입력은 YYYY-MM-DD 형식이며, 존재하는 날짜이고, 시작일 이상이어야 한다.
- 예시/테스트 시나리오 검증을 위해 상한 날짜 2025-12-31을 사용한다.

## 목표가 아닌 것 (Non-Goals)

- 반복 횟수 기반 종료(예: N회 후 종료)
- 요일 패턴/규칙(예: 매월 첫째 주 월요일)
- 개별 인스턴스의 예외 처리(스킵, 편집, 삭제)

## 계획 (Plan)

### 예상 동작 (Expected Behaviors)

각 동작은 Given-When-Then 형식의 검증 포인트를 포함한다. 모든 예시는 상한 날짜 2025-12-31을 적용한다.

#### 1. 종료일 입력 및 기본 동작

**동작 명세**:

- 반복 일정이 활성화된 상태에서 종료일을 입력할 수 있다.
- 종료일이 비어 있으면 무기한으로 간주하고, 화면 표시 범위 내에서만 생성/표시한다.
- 종료일이 설정되면 해당 날짜를 포함해 그 이전까지만 인스턴스를 생성/표시한다.

**검증 포인트**:

```
Given: 시작일 2025-01-10, repeat.type='daily', interval=1, endDate='2025-01-13'
When: 주간/월간 뷰에서 일정을 조회
Then: 2025-01-10, 11, 12, 13에만 표시되고 14 이후는 표시되지 않음

Given: 시작일 2025-01-10, repeat.type='daily', interval=1, endDate=''
When: 월간 뷰에서 일정을 조회
Then: 종료일 제약 없이 표시 범위 내에서만 표시됨
```

#### 2. 형식 및 유효성 검증

**동작 명세**:

- 종료일 입력은 YYYY-MM-DD 형식만 허용한다.
- 존재하지 않는 날짜는 허용하지 않는다.
- 종료일은 시작일보다 과거일 수 없다(시작일과 동일은 허용).

**검증 포인트**:

```
Given: 반복 종료일 입력 필드
When: '2025-1-5' 입력 (형식 오류)
Then: "날짜 형식이 올바르지 않습니다. (YYYY-MM-DD)" 오류 표시

Given: 반복 종료일 입력 필드
When: '2025-02-30' 입력 (존재하지 않는 날짜)
Then: "유효하지 않은 날짜입니다." 오류 표시

Given: 시작일 '2025-03-10', 종료일 '2025-03-09'
When: 검증 수행
Then: "종료일은 시작일보다 미래여야 합니다." 오류 표시

Given: 시작일 '2025-03-10', 종료일 '2025-03-10'
When: 검증 수행
Then: 오류 없음 (시작일과 동일 허용)
```

#### 3. 상한 날짜(예시/테스트 전용) 적용

**동작 명세**:

- 예시 및 테스트 시나리오에서는 종료일이 없을 때도 2025-12-31을 상한으로 사용하여 결과를 설명한다.
- 실제 앱 로직은 "종료일(있는 경우)"과 "화면 표시 범위"를 사용하며, 문서 내 예시는 상한을 2025-12-31로 고정하여 재현성을 확보한다.

**검증 포인트**:

```
Given: 시작일 2025-12-30, repeat.type='daily', interval=1, endDate 없음
When: 예시 기준(상한 2025-12-31)으로 생성 집합 설명
Then: 2025-12-30, 2025-12-31까지만 생성된 것으로 간주
```

#### 4. 반복 유형별 종료일 적용 - 매일

**동작 명세**:

- 시작일부터 종료일까지 매 N일 간격으로 인스턴스를 생성한다.
- 종료일이 설정되면 종료일을 포함하여 그 이전까지만 생성한다.

**검증 포인트**:

```
Given: 시작일 2025-01-01, interval=2, endDate='2025-01-07'
When: 일정 생성
Then: 2025-01-01, 03, 05, 07 생성
```

#### 5. 반복 유형별 종료일 적용 - 매주

**동작 명세**:

- 시작일과 같은 요일 기준으로 매 N주 간격으로 생성한다.
- 종료일이 설정되면 종료일을 포함하여 그 이전까지만 생성한다.

**검증 포인트**:

```
Given: 시작일 2025-01-06(월), interval=1, endDate='2025-01-20'
When: 일정 생성
Then: 2025-01-06, 2025-01-13, 2025-01-20 생성
```

#### 6. 반복 유형별 종료일 적용 - 매월 (존재하지 않는 날짜 건너뜀)

**동작 명세**:

- 시작일의 일(day)이 존재하는 달에만 생성한다. 존재하지 않으면 해당 달은 건너뛴다.
- 종료일이 설정되면 종료일을 포함하여 그 이전까지만 생성한다.

**검증 포인트**:

```
Given: 시작일 2025-01-31, interval=1, endDate='2025-04-30'
When: 일정 생성
Then: 2025-01-31, (2월 건너뜀), 2025-03-31 생성, 2025-04-30은 시작일의 일(31)이 없어 생성되지 않음
```

#### 7. 반복 유형별 종료일 적용 - 매년 (윤년 2/29 특수 케이스)

**동작 명세**:

- 시작일의 월/일이 존재하는 해에만 생성한다.
- 종료일이 설정되면 종료일을 포함하여 그 이전까지만 생성한다.

**검증 포인트**:

```
Given: 시작일 2024-02-29(윤년), interval=1, endDate='2025-12-31'
When: 일정 생성
Then: 2024-02-29만 생성되고 2025년에는 생성되지 않음 (평년)
```

### 기술 요구사항

#### 1. 데이터 타입

```typescript
// src/types.ts 참고
export type RepeatType = 'none' | 'daily' | 'weekly' | 'monthly' | 'yearly';

export interface RepeatInfo {
  type: RepeatType;
  interval: number;
  endDate?: string; // YYYY-MM-DD
}

export interface EventForm {
  title: string;
  date: string; // YYYY-MM-DD
  startTime: string;
  endTime: string;
  description: string;
  location: string;
  category: string;
  repeat: RepeatInfo;
  notificationTime: number; // minutes
}
```

#### 2. 유효성 검증 규칙 (정확 문자열)

- 종료일 형식 오류: "날짜 형식이 올바르지 않습니다. (YYYY-MM-DD)"
- 종료일 존재 오류: "유효하지 않은 날짜입니다."
- 시작/종료 관계 오류: "종료일은 시작일보다 미래여야 합니다."
- 관계 규칙: 종료일은 시작일 이상(동일 허용)

#### 3. 생성 알고리즘 (종료일 반영)

- 공통: `until = min(종료일(있다면), 화면 표시 범위 끝)`
- 매일: 시작일부터 `until`까지 `interval`일씩 증가하며 d ≤ until인 d에 생성
- 매주: 시작 요일 기준 `interval*7`일씩 증가하며 d ≤ until인 d에 생성
- 매월: 해당 월에 시작일의 day가 존재할 때만 생성, 월을 `interval`개월씩 증가, d ≤ until
- 매년: 해당 해에 시작일의 월/일이 존재할 때만 생성, 해를 `interval`년씩 증가, d ≤ until

의사코드:

```
until = endDate ?? rangeEnd
for (d = start; d <= until && d <= rangeEnd; d = stepByType(d, type, interval)) {
  if (type === 'monthly' && !monthHasDay(d.year, d.month, start.day)) continue;
  if (type === 'yearly'  && !dateExists(d.year, start.month, start.day)) continue;
  emit(d)
}
```

#### 4. UI 연동 (참고)

- `App.tsx`: 반복 설정 UI에 종료일 텍스트 필드 존재 (`repeatEndDate`)
- `useEventForm`: `endDateError`에서 형식/존재/관계 검증 수행, `getRepeatInfo()`로 `endDate`를 저장

### 제약사항 및 에지 케이스

- 종료일이 시작일보다 과거인 경우: 저장 불가, 오류 메시지 노출(정확 문자열)
- 종료일이 시작일과 동일: 허용, 해당 일자 1건 생성
- 매월 31일, 30일, 29일: 해당 일이 존재하지 않는 달은 건너뜀
- 윤년 2/29: 평년에는 생성되지 않음, 변환(2/28, 3/1) 금지
- 예시 상한: 문서/테스트 시나리오에서는 2025-12-31을 상한으로 사용해 결과 집합을 설명

### 구현 우선순위

1. 높음: 종료일 입력/검증(`useEventForm` 연동), 생성 알고리즘의 종료일 반영
2. 중간: 월/년 특수 케이스 건너뛰기 로직 점검 (31일, 2/29)
3. 낮음: 예시 상한(2025-12-31) 기반 문서/테스트 보조 유틸

---

## 작성 체크리스트 점검

- [x] 모든 동작에 "동작 명세"와 "검증 포인트" 존재
- [x] 검증 포인트가 Given-When-Then 형식으로 작성됨
- [x] 구체적인 데이터와 값 사용 (YYYY-MM-DD, 2025-12-31 등)
- [x] 오류 메시지가 정확한 문자열로 명시됨
- [x] 데이터 타입과 검증 규칙 제공됨
- [x] 에지 케이스가 구체적으로 나열됨
- [x] 구현 우선순위 제안됨
- [x] 기존 코드베이스와의 연결점(`src/types.ts`, `useEventForm`, `App.tsx`) 파악됨
